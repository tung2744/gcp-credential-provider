#!/usr/bin/python3

import sys
import json
import logging
import argparse
import subprocess
import re
import os
import tempfile


def configure_logging(log_level, log_file=None):
    logger = logging.getLogger()
    logger.setLevel(log_level)

    if log_file:
        log_handler = logging.FileHandler(log_file)
    else:
        log_handler = logging.StreamHandler(sys.stderr)
    log_handler.setLevel(log_level)

    # Create a formatter and set it on the handler
    formatter = logging.Formatter("%(levelname)s: %(message)s")
    log_handler.setFormatter(formatter)

    # Add the stderr handler to the logger
    logger.addHandler(log_handler)


def read_json_from_stdin():
    # Read the input JSON from stdin
    json_data = sys.stdin.read()

    try:
        # Parse the JSON data
        parsed_data = json.loads(json_data)
        return parsed_data
    except json.JSONDecodeError as e:
        logging.error("Error: Invalid JSON - %s", str(e))
        sys.exit(1)


def get_image_repository(url: str):
    url_parse = re.compile(r"([a-z0-9-\.]*)/.*")

    return url_parse.match(url).group(1)


# Generated by
# gcloud iam workload-identity-pools create-cred-config  \
#   projects/{project_number}/locations/global/workloadIdentityPools/{provider_pool_id}/providers/{provider_id}   \
#   --output-file=sts-creds.json  \
#   --executable-command="echo -n {\"version\":1,\"success\":true,\"token_type\":\"urn:ietf:params:oauth:token-type:id_token\",\"id_token\": \"{service_account_token}\"}"
STS_CRED_JSON_TEMPLATE = """{
  "universe_domain": "googleapis.com",
  "type": "external_account",
  "audience": "//iam.googleapis.com/projects/{project_number}/locations/global/workloadIdentityPools/{provider_pool_id}/providers/{provider_id}",
  "subject_token_type": "urn:ietf:params:oauth:token-type:jwt",
  "token_url": "https://sts.googleapis.com/v1/token",
  "credential_source": {
    "executable": {
      "command": "echo -n {\"version\":1,\"success\":true,\"token_type\":\"urn:ietf:params:oauth:token-type:id_token\",\"id_token\": \"{service_account_token}\"}",
      "timeout_millis": 30000
    }
  },
  "token_info_url": "https://sts.googleapis.com/v1/introspect"
}"""


def get_credentials(service_account_token: str, registry: str):
    sts_cred = (
        STS_CRED_JSON_TEMPLATE.replace(
            "{project_number}",
            os.environ["GOOGLE_PROJECT_NUMBER"],
        )
        .replace(
            "{provider_pool_id}",
            os.environ["GOOGLE_PROVIDER_POOL_ID"],
        )
        .replace(
            "{provider_id}",
            os.environ["GOOGLE_PROVIDER_ID"],
        )
        .replace("{service_account_token}", service_account_token)
    )
    command = "docker-credential-gcr get"
    subpenv = os.environ.copy()

    temp_file_path = None
    try:
        with tempfile.NamedTemporaryFile(mode="w", delete=False) as temp_file:
            temp_file.write(sts_cred)
            temp_file_path = temp_file.name

        subpenv["GOOGLE_APPLICATION_CREDENTIALS"] = temp_file_path
        subpenv["GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES"] = "1"
    finally:
        if temp_file_path and os.path.exists(temp_file_path):
            os.remove(temp_file_path)

    try:
        # Run the command as a subprocess
        process = subprocess.Popen(
            command,
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            env=subpenv,
            shell=True,
        )

        # Pass stdin text to the subprocess
        stdout, stderr = process.communicate(input=f"https://{registry}".encode())
    except subprocess.CalledProcessError as e:
        print(f"Command execution failed with return code {e.returncode}")
        sys.exit(1)

    if process.returncode != 0:
        logging.error(f"Error: {stderr}")
        exit(1)

    # Parse the command output as JSON
    try:
        return json.loads(stdout)
    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON - {str(e)}")
        sys.exit(1)


def credential_response(registry, username, password):
    response = {
        "apiVersion": "credentialprovider.kubelet.k8s.io/v1",
        "kind": "CredentialProviderResponse",
        "cacheKeyType": "Registry",
        "auth": {f"{registry}": {"username": str(username), "password": str(password)}},
    }
    print(
        json.dumps(response),
        end=None,
    )


if __name__ == "__main__":
    # Configure argparse
    parser = argparse.ArgumentParser(description="Read JSON from stdin")
    parser.add_argument(
        "-v", "--verbose", action="store_true", help="enable verbose logging"
    )
    parser.add_argument("--log-file", default=None, help="Sendo logs to file")
    args = parser.parse_args()

    # Configure logging
    log_level = logging.DEBUG if args.verbose else logging.INFO
    configure_logging(log_level, args.log_file)

    # Call the function to read JSON from stdin
    json_data = read_json_from_stdin()
    logging.debug("Request JSON data: %s", json_data)

    repository = get_image_repository(json_data["image"])
    service_account_token = json_data["serviceAccountToken"]

    credentials = get_credentials(service_account_token, repository)
    logging.debug(
        "Registry: %s Credential User: %s", repository, credentials["Username"]
    )

    credential_response(repository, credentials["Username"], credentials["Secret"])
